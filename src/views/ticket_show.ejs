<section class="card" style="padding:18px">
  <h1 style="margin:0 0 10px">Ticket #<%= t.id %> — <%= t.subject %></h1>

  <!-- Controles de estado (Aceptar / Liberar / Solucionado / etc.).
       Se pasa viewMode para ocultar botones según contexto. -->
  <%- include('partials/ticket-status-controls', { t, userRole, userId, assignables, canClose, viewMode, canAccept }) %>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:900px">
    <div>
      <div><b>Departamento:</b> <%= t.department %></div>
      <div><b>Categoría:</b> <%= t.category %></div>
      <div><b>Estatus:</b> <%= t.status %></div>
      <div><b>Abierto:</b> <%= new Date(t.opened_at).toLocaleString() %></div>
      <% if (t.updated_at) { %>
        <div><b>Actualizado:</b> <%= new Date(t.updated_at).toLocaleString() %></div>
      <% } %>
      <% if (t.closed_at) { %>
        <div><b>Cerrado:</b> <%= new Date(t.closed_at).toLocaleString() %></div>
      <% } %>
    </div>
    <div>
      <div><b>Creado por:</b> <%= t.created_by_name %></div>
      <% if (t.assigned_to_name) { %>
        <div><b>Asignado a:</b> <%= t.assigned_to_name %></div>
      <% } %>
      <div><b>Reportante:</b> <%= t.creator_name %></div>
      <% if (t.contact_phone) { %>
        <div><b>Teléfono:</b> <%= t.contact_phone %></div>
      <% } %>
    </div>
  </div>

  <hr style="margin:16px 0;border:0;border-top:1px solid #e5e7eb"/>

  <h3>Descripción</h3>
  <p style="white-space:pre-wrap"><%= t.description %></p>

  <% if (attachments && attachments.length) { %>
    <hr style="margin:16px 0;border:0;border-top:1px solid #e5e7eb"/>
    <h3>Evidencias</h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px">
      <% attachments.forEach(a => { %>
        <a href="/attachments/<%= a.id %>/raw" target="_blank" style="display:block">
          <img src="/attachments/<%= a.id %>/thumb"
               alt="Evidencia <%= a.seq %>"
               style="width:100%;height:auto;border:1px solid #e5e7eb;border-radius:8px"/>
        </a>
      <% }) %>
    </div>
  <% } %>

  <!-- Historial de transiciones -->
  <%- include('partials/ticket-history', { history, statusLabels, roleMap }) %>

  <!-- Controles de exportación / impresión -->
  <% // Mostrar botones de exportar e imprimir sólo para roles con permisos de gestión
     const allowedExportRoles = ['admin','manager','agente'];
     if (allowedExportRoles.includes(userRole)) { %>
    <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap">
      <!-- Exportar a CSV: descarga un reporte con los detalles e historial -->
      <a href="/tickets/<%= t.id %>/export" class="btn btn-secondary" target="_blank">Exportar XLS</a>
      <!-- Imprimir: permite imprimir o guardar como PDF mediante el diálogo del navegador -->
      <button type="button" class="btn btn-secondary" onclick="window.print()">Imprimir</button>
    </div>
  <% } %>

  <div style="margin-top:16px">
    <a class="btn btn-secondary" href="<%= viewMode === 'requested' ? '/tickets/requested' : '/tickets' %>">← Volver al listado</a>
  </div>
</section>

<!-- Script para manejo de transiciones -->
<!--
  Se pasa información adicional al script mediante atributos data-*.  Además del
  ID del ticket y la raíz opcional, incluimos el nombre del departamento
  asociado al ticket.  Esto permite que el cliente muestre un diálogo
  adicional cuando se marca como solucionado un ticket de los departamentos
  "Mantenimiento" o "Sistemas" para registrar los cambios de piezas.
-->
<script src="/js/ticket-show.js"
        data-ticket-id="<%= t.id %>"
        data-root=""
        data-department="<%= t.department %>"></script>
