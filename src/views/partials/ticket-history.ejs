<h3 style="margin:16px 0 8px">Historial</h3>
<style>
  /* Estilos para el historial de transiciones y comentarios */
  .history-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px;}
  .history-entry{padding-bottom:8px;border-bottom:1px solid #e5e7eb;}
  .history-entry:last-child{border-bottom:none;}
  .history-meta{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;}
  .history-date{color:#475569;min-width:160px;font-size:0.875rem;}
  .history-role{font-weight:bold;}
  .history-actor-name{font-weight:normal;}
  .history-comment{color:#475569;font-style:italic;}
  .history-change{color:#475569;}
</style>
<div style="border:1px solid #e2e8f0;border-radius:8px;padding:8px">
  <% if (!history || !history.length) { %>
    <div style="color:#64748b">Sin movimientos.</div>
  <% } else { %>
    <ul class="history-list">
      <% history.forEach(h => { %>
        <li class="history-entry">
          <div class="history-meta">
            <span class="history-date"><%= new Date(h.created_at).toLocaleString() %></span>
            <span class="history-role"><%= (typeof roleMap !== 'undefined' && roleMap[h.actor_role] ? roleMap[h.actor_role] : (h.actor_role || '')).toUpperCase() %></span>
            <% if (h.actor_name) { %>
              <span class="history-actor-name"><%= h.actor_name %></span>
            <% } %>
          </div>
          <% if (h.from_status && h.to_status && h.from_status === h.to_status) { %>
            <div class="history-comment">
              <strong>Comentario:</strong>
              <span><%= h.note || '' %></span>
            </div>
          <% } else { %>
            <div class="history-change">
              <span>Pasó de <b><%= statusLabels[h.from_status] %></b> a <b><%= statusLabels[h.to_status] %></b></span>
              <% if (h.note) { %>
                <span> — <i><%= h.note %></i></span>
              <% } %>
            </div>
          <% } %>
        </li>
      <% }) %>
    </ul>
  <% } %>
</div>