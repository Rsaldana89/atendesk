<%
// helpers for role and state checks
const can = arr => arr.includes(userRole);
const s   = t.status;
%>
<div class="controls" style="display:flex; gap:8px; flex-wrap:wrap; margin:12px 0">
  <!-- Aceptar: convierte un ticket abierto en en_progreso y lo asigna al agente actual. -->
  <% if (s === 'abierto' && can(['admin','manager','agent'])) { %>
    <button class="btn" data-to="en_progreso">Aceptar</button>
  <% } %>

  <!-- Liberar: regresa un ticket en progreso a abierto y libera la asignación. -->
  <% if (s === 'en_progreso' && (can(['admin','manager']) || (userRole === 'agent' && t.assigned_to === userId))) { %>
    <button class="btn btn-secondary" data-to="abierto">Liberar</button>
  <% } %>

  <!-- Marcar solucionado: desde en_progreso o reabierto → solucionado. -->
  <% if ((s === 'en_progreso' || s === 'reabierto') && can(['admin','manager','agent'])) { %>
    <button class="btn" data-to="solucionado">Solucionado</button>
  <% } %>

  <!-- Cerrar: desde solucionado → cerrado. -->
  <% if (s === 'solucionado' && can(['admin','user'])) { %>
    <button class="btn" data-to="cerrado">Cerrar</button>
  <% } %>

  <!-- Reabrir: desde solucionado o cerrado → reabierto. -->
  <% if ((s === 'solucionado' || s === 'cerrado') && can(['admin','manager','agent','user'])) { %>
    <button class="btn" data-to="reabierto">Reabrir</button>
  <% } %>

  <!-- Cancelar: desde cualquier estado activo (no final) → cancelado.  Solo admin, manager o usuario. -->
  <% if (['abierto','en_progreso','reabierto','solucionado'].includes(s) && can(['admin','manager','user'])) { %>
    <button class="btn btn-secondary" data-to="cancelado">Cancelar</button>
  <% } %>
</div>

<!-- Se eliminó el estilo inline de los botones para utilizar las clases globales definidas en styles.css -->