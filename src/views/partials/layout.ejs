<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= title || 'HelpDesk Soluciones CHC' %></title>
  <link rel="stylesheet" href="/css/styles.css">

  <style>
    :root{
      --nav-bg:#0f172a;
      --nav-bd:#1f2937;
      --nav-fg:#e2e8f0;
      --chip-bg:#111827;
      --chip-bd:#374151;
      --chip-fg:#e5e7eb;
      --chip-hover:#1f2937;
      --chip-active:#1d4ed8;
      --primary:#2563eb;
      --primary-hover:#1e40af;
      --container:1100px;
      --gap:8px;
    }

    /* ===== Topbar / contenedor ===== */
    .topbar{
      position: sticky; top:0; z-index:100;
      background:var(--nav-bg); color:var(--nav-fg); border-bottom:1px solid var(--nav-bd);
    }
    .topbar .bar{
      max-width:var(--container); margin:0 auto; padding:10px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ font-weight:700; letter-spacing:.2px; white-space:nowrap; }

    /* ===== Bot√≥n hamburguesa ===== */
    .menu-toggle{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:8px 12px; border-radius:999px; border:1px solid var(--chip-bd);
      background:var(--chip-bg); color:var(--chip-fg); cursor:pointer;
    }
    .menu-toggle:hover{ background:var(--chip-hover); border-color:#475569; }
    .menu-icon{ width:20px; height:20px; display:inline-block; }

    /* ===== Panel de navegaci√≥n (colapsable en m√≥vil) ===== */
    .nav-panel{ display:none; border-top:1px solid var(--nav-bd); }
    .nav-panel.open{ display:block; }
    .nav-panel .inner{
      max-width:var(--container); margin:0 auto; padding:12px 16px;
      display:grid; gap:10px;
    }

    /* Grupos: enlaces a la izquierda, usuario/acciones a la derecha en desktop */
    .nav-left, .nav-right{
      display:flex; flex-wrap:wrap; gap:var(--gap);
    }

    /* Chips / botones */
    .btn-nav{
      --bg:var(--chip-bg); --fg:var(--chip-fg); --bd:var(--chip-bd);
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; border:1px solid var(--bd);
      background:var(--bg); color:var(--fg); text-decoration:none; line-height:1;
      transition: transform .05s ease, background .15s ease, border-color .15s ease, color .15s ease;
      white-space:nowrap;
    }
    .btn-nav:hover{ background:var(--chip-hover); border-color:#475569; }
    .btn-nav:active{ transform: translateY(1px); }
    .btn-nav.active{ background:var(--chip-active); border-color:var(--chip-active); color:#fff; }
    .btn-primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn-primary:hover{ background:var(--primary-hover); border-color:var(--primary-hover); }

    .icon{ width:18px; height:18px; display:inline-block; }

    /* Usuario pill */
    .user-name{ font-weight:600; color:#f1f5f9; display:inline-flex; align-items:center; gap:6px; }

    /* Logout con estilo chip */
    .logout-form{ margin:0; }
    .logout-form button{
      all:unset; cursor:pointer;
      padding:8px 12px; border-radius:999px; border:1px solid var(--chip-bd);
      background:var(--chip-bg); color:var(--chip-fg); display:inline-flex; align-items:center; gap:8px;
      transition: background .15s ease, border-color .15s ease;
    }
    .logout-form button:hover{ background:var(--chip-hover); border-color:#475569; }

    /* Accesibilidad foco */
    .btn-nav:focus-visible, .menu-toggle:focus-visible, .logout-form button:focus-visible{
      outline:2px solid #93c5fd; outline-offset:2px;
    }

    /* ===== Desktop (‚â•900px): men√∫ inline y hamburguesa oculta ===== */
    @media (min-width:900px){
      .menu-toggle{ display:none; }
      .nav-panel{ display:block; border-top:none; }
      .nav-panel .inner{
        padding:0 16px 10px;
        display:flex; align-items:center; gap:12px;
      }
      .nav-left{ flex: 1 1 auto; }
      .nav-right{ margin-left:auto; gap:10px; align-items:center; }
    }

    /* ===== Layout contenido y footer ===== */
    .container.content{ max-width:var(--container); margin:18px auto; padding:0 16px; }

    .app-footer {
      margin-top: 2rem; padding: 1rem; text-align: center; font-size: 0.95rem;
      color: #f1f5f9; background: #1e293b; border-top: 2px solid #3b82f6;
    }
    .app-footer .footer-link { color:#3b82f6; text-decoration:none; font-weight:600; margin:0 8px; }
    .app-footer .footer-link:hover { text-decoration:underline; }

    /* ===== Modal "Acerca de" ===== */
    .modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.5); }
    .modal-content {
      background:#fff; margin:12% auto; padding:20px 30px; border-radius:12px;
      width:90%; max-width:400px; text-align:center; box-shadow:0 8px 20px rgba(0,0,0,.25); position:relative;
    }
    .modal-content h3{ margin-top:0; color:#1e293b; }
    .modal-content p{ margin:6px 0; color:#334155; }
    .modal .close{ position:absolute; top:10px; right:20px; font-size:24px; cursor:pointer; color:#64748b; }
    .modal .close:hover{ color:#ef4444; }

    /* Utilidad */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="bar">
      <div class="brand">HelpDesk Soluciones CHC</div>

      <!-- Bot√≥n hamburguesa (visible en m√≥vil) -->
      <button class="menu-toggle" id="menu-toggle" aria-expanded="false" aria-controls="primary-nav">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
        <span class="sr-only">Abrir men√∫</span>
      </button>
    </div>

    <!-- NAV: colapsable en m√≥vil, inline en desktop -->
    <nav id="primary-nav" class="nav-panel" aria-label="Principal">
      <div class="inner">
        <div class="nav-left">
          <% if (user) { %>
            <!-- Inicio -->
            <a href="/dashboard"
               class="btn-nav <%= path && path.startsWith('/dashboard') ? 'active' : '' %>">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5z"/>
              </svg>
              Inicio
            </a>

            <!-- Tickets admin/manager/agent -->
            <% if (user.role === 'admin' || user.role === 'manager' || user.role === 'agent') { %>
              <a href="/tickets"
                 class="btn-nav <%= path && path.startsWith('/tickets') && !path.startsWith('/tickets/requested') && !path.includes('/new') ? 'active' : '' %>">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M4 6h16v6a2 2 0 1 0 0 4v2H4v-2a2 2 0 1 0 0-4V6z"/>
                </svg>
                Tickets por atender
              </a>
              <a href="/tickets/requested"
                 class="btn-nav <%= path && path.startsWith('/tickets/requested') ? 'active' : '' %>">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M4 6h16v6a2 2 0 1 0 0 4v2H4v-2a2 2 0 1 0 0-4V6z"/>
                </svg>
                Tickets solicitados
              </a>
            <% } else { %>
              <!-- Usuarios finales -->
              <a href="/tickets/requested"
                 class="btn-nav <%= path && path.startsWith('/tickets') ? 'active' : '' %>">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M4 6h16v6a2 2 0 1 0 0 4v2H4v-2a2 2 0 1 0 0-4V6z"/>
                </svg>
                Tickets solicitados
              </a>
            <% } %>

            <!-- Nuevo -->
            <a href="/tickets/new" class="btn-nav btn-primary <%= path === '/tickets/new' ? 'active' : '' %>">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Nuevo
            </a>

            <!-- Anuncios -->
            <a href="/announcements"
               class="btn-nav <%= path && path.startsWith('/announcements') ? 'active' : '' %>">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path d="M4 19h16M6 17V7m6 10V5m6 12v-8"/>
              </svg>
              Anuncios
            </a>

            <!-- Informes y Estad√≠sticas -->
            <% if (user.role === 'admin' || user.role === 'manager') { %>
              <a href="/reports"
                 class="btn-nav <%= path && path.startsWith('/reports') ? 'active' : '' %>">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M4 19h16M6 17V7m6 10V5m6 12v-8"/>
                </svg>
                Informes y Estad√≠sticas
              </a>
            <% } %>

            <!-- Administraci√≥n -->
            <% if (user.role === 'admin') { %>
              <a href="/admin/users"
                 class="btn-nav <%= path && path.startsWith('/admin') ? 'active' : '' %>">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M16 14a4 4 0 1 0-8 0v5h8v-5z"/>
                  <circle cx="12" cy="7" r="3"></circle>
                </svg>
                Administraci√≥n
              </a>
            <% } %>
          <% } %>
        </div>

        <div class="nav-right">
          <% if (user) { %>
            <span class="user-name">üë§ <%= user.full_name %> <% if (user.role) { %>¬∑ <small style="opacity:.8;text-transform:capitalize"><%= user.role %></small><% } %></span>

            <form method="post" action="/logout" class="logout-form">
              <button type="submit" title="Cerrar sesi√≥n">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                  <path d="M10 17l-5-5 5-5M5 12h11"/>
                </svg>
                Cerrar sesi√≥n
              </button>
            </form>
          <% } else { %>
            <a href="/login" class="btn-nav <%= path === '/login' ? 'active' : '' %>">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <path d="M14 17l5-5-5-5M19 12H8"/>
              </svg>
              Login
            </a>
          <% } %>
        </div>
      </div>
    </nav>
  </header>

  <main class="container content">
    <%- body %>
  </main>

  <footer class="app-footer">
    <a href="/manual.html" target="_blank" class="footer-link">üìñ Manual de Usuario</a>
    ¬∑
    <a href="#" id="about-link" class="footer-link">‚ÑπÔ∏è Acerca de</a>
  </footer>

  <!-- Modal "Acerca de" -->
  <div id="about-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="about-title">
    <div class="modal-content">
      <span class="close" aria-label="Cerrar">&times;</span>
      <h3 id="about-title">HelpDesk Soluciones CHC</h3>
      <p><strong>Versi√≥n:</strong> 0.83 Alpha</p>
      <p>Desarrollado por <strong>Rub√©n Salda√±a Alvarado</strong></p>
      <p>para <strong>Cremer√≠a Hermanos Coronel</strong></p>
    </div>
  </div>

  <script>
    // ========== Men√∫ responsivo ==========
    const toggle = document.getElementById('menu-toggle');
    const nav = document.getElementById('primary-nav');

    function setOpen(isOpen){
      nav.classList.toggle('open', isOpen);
      toggle.setAttribute('aria-expanded', String(isOpen));
    }

    toggle.addEventListener('click', () => {
      setOpen(!nav.classList.contains('open'));
    });

    // Cerrar al navegar (en m√≥vil)
    nav.addEventListener('click', (e) => {
      if (e.target.closest('a')) setOpen(false);
    });

    // Cerrar con Escape
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') setOpen(false);
    });

    // Reset al pasar a desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 900) setOpen(false);
    });

    // ========== Modal "Acerca de" ==========
    const aboutLink = document.getElementById("about-link");
    const aboutModal = document.getElementById("about-modal");
    const closeBtn = aboutModal.querySelector(".close");

    aboutLink.addEventListener("click", (e) => {
      e.preventDefault();
      aboutModal.style.display = "block";
    });
    closeBtn.addEventListener("click", () => aboutModal.style.display = "none");
    window.addEventListener("click", (e) => { if (e.target === aboutModal) aboutModal.style.display = "none"; });
    window.addEventListener("keydown", (e) => { if (e.key === 'Escape') aboutModal.style.display = "none"; });
  </script>
</body>
</html>
